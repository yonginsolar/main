<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="layer"><div style="cursor:pointer;position:absolute;right:0;top:0;width:40px;height:40px;background:#333;color:white;text-align:center;line-height:40px;font-weight:bold;" onclick="closeDaumPostcode()">Ã—</div></div>

    <div class="container">
      <div class="info-box">
        <div class="info-text">ì‹ ì²­ì„œ ì‘ì„± í›„ ì¶œìê¸ˆì„ ì…ê¸ˆí•˜ì‹œë©´ ê°€ì…ì´ ì™„ë£Œë©ë‹ˆë‹¤.</div>
        <div class="info-text">ì´í›„ ë°œì „ì†Œ ê±´ë¦½ ì‹œ ì¶œìê¸ˆì„ ì¦ì•¡í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <div class="contact-info">ë¬¸ì˜: ì‚¬ë¬´êµ­ì¥ ê¹€ë¯¼í˜¸ 010-2513-5736 / yonginsolar@gmail.com</div>
      </div>

      <form id="joinForm" onsubmit="handleFormSubmit(event, this)">
        <div class="type-selector">
          <label class="radio-label"><input type="radio" name="userType" value="ê°œì¸" checked onclick="toggleType('ê°œì¸')"> ê°œì¸</label>
          <label class="radio-label"><input type="radio" name="userType" value="ë‹¨ì²´" onclick="toggleType('ë‹¨ì²´')"> ë‹¨ì²´</label>
        </div>

        <div id="individualField">
          <div class="input-group"><label class="required">ì´ë¦„</label><input type="text" id="userName" name="userName" placeholder="ì‹¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required oninput="syncAccountHolder()"></div>
<div class="input-group"><label class="required">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label>
  <div class="split-box">
    <input type="text" id="rrn1" name="rrn1" maxlength="6" placeholder="ì• 6ìë¦¬" style="flex:1;" 
           oninput="handleNumberOnly(this); autoMove(this, 'rrn2', 6); checkAgeLimit(); document.getElementById('rrnError').textContent='';" required>
    <span class="dash">-</span>
    <input type="password" id="rrn2" name="rrn2" maxlength="7" placeholder="ë’¤ 7ìë¦¬" style="flex:1;" 
           oninput="handleNumberOnly(this); checkAgeLimit(); document.getElementById('rrnError').textContent='';" 
            required>
  </div>
  <div id="rrnError" class="field-error"></div>
</div>
        </div>

        <div id="orgField" style="display:none;">
          <div class="input-group"><label class="required">ë‹¨ì²´ëª…</label><input type="text" id="orgName" name="orgName" placeholder="ì˜ˆ: (ì£¼)ìš©ì¸ì†”ë¼, OOì•„íŒŒíŠ¸ì…ì£¼ìëŒ€í‘œíšŒì˜" oninput="syncAccountHolder()"></div>
          <div class="input-group"><label class="required">ì‚¬ì—…ì(ê³ ìœ )ë²ˆí˜¸</label>
            <div class="split-box">
              <input type="text" id="biz1" maxlength="3" placeholder="3ìë¦¬" style="flex:1;" oninput="handleNumberOnly(this); autoMove(this, 'biz2', 3);">
              <span class="dash">-</span>
              <input type="text" id="biz2" maxlength="2" placeholder="2ìë¦¬" style="flex:1;" oninput="handleNumberOnly(this); autoMove(this, 'biz3', 2);">
              <span class="dash">-</span>
              <input type="text" id="biz3" maxlength="5" placeholder="5ìë¦¬" style="flex:2;" oninput="handleNumberOnly(this);" onblur="validateAndCheckBizNo()">
            </div>
            <div id="orgNoError" class="field-error"></div>
            <input type="hidden" id="orgNo" name="orgNo">
          </div>
        </div>

        <div class="input-group"><label class="required">ì—°ë½ì²˜</label>
          <div class="split-box">
            <input type="text" id="p1" maxlength="3" value="010" style="flex:1;" oninput="handleNumberOnly(this); autoMove(this, 'p2', 3)">
            <span class="dash">-</span>
            <input type="text" id="p2" maxlength="4" style="flex:1;" oninput="handleNumberOnly(this); autoMove(this, 'p3', 4)">
            <span class="dash">-</span>
            <input type="text" id="p3" maxlength="4" style="flex:1;" oninput="handleNumberOnly(this)" onblur="checkPhoneDuplicateServer()">
          </div>
          <div id="phoneError" class="field-error"></div><input type="hidden" name="phone" id="fullPhone">
        </div>

        <div class="input-group"><label class="required">ì£¼ì†Œ</label>
          <div class="split-box">
            <input type="text" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" style="flex:1;" readonly>
            <button type="button" class="btn-dark" onclick="execDaumPostcode()">ì£¼ì†Œ ê²€ìƒ‰</button>
          </div>
          <div style="margin-top: 8px;"><input type="text" id="roadAddress" placeholder="ë„ë¡œëª…/ì§€ë²ˆ ì£¼ì†Œ" readonly></div>
          <div style="margin-top: 8px;"><input type="text" id="detailAddress" placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥" required></div>
          <input type="hidden" name="address" id="fullAddress">
        </div>

        <div class="input-group"><label class="required">ì´ë©”ì¼ ì£¼ì†Œ</label>
          <div class="split-box">
            <input type="email" id="email" name="email" placeholder="example@email.com" style="flex:1;">
            
            <button type="button" class="btn-edit" onclick="enableEmailEdit()" id="btnEmailEdit">ìˆ˜ì •</button>
            <button type="button" class="btn-dark" onclick="reqEmailAuth()" id="btnEmailReq">ì¸ì¦</button>
          </div>
          <div id="authBox" style="display: none; align-items: center; gap: 8px; margin-top:8px;">
            <input type="text" id="authCode" placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬" maxlength="6" style="flex:1;" oninput="handleAuthCodeInput()">
            <span id="timer" style="font-size:12px; color:red; font-weight:bold; min-width:40px; text-align:center;">05:00</span>
          </div>
          <div id="authSuccessMsg" style="display:none; color:green; font-size:12px; margin-top:4px; font-weight:bold;">ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
          <div id="emailError" class="field-error"></div><input type="hidden" id="isEmailVerified" value="false">
        </div>

        <div class="input-group"><label class="required">ì¶œìê¸ˆ ì•½ì • <span style="font-size:11px; font-weight:normal; color:#888;">(10ë§Œì› ì´ìƒ, 1ë§Œì› ë‹¨ìœ„)</span></label>
          <input type="number" id="money" name="money" placeholder="ìˆ«ìë§Œ ì…ë ¥ (ì˜ˆ: 100000)" min="100000" step="10000" oninput="updateMoneyHint()" required>
          <div id="moneyHint" style="margin-top:4px; font-size:12px; color:#666;"></div>
        </div>

        <div class="input-group">
          <label>ì¶”ì²œì¸ <span style="font-size:11px; font-weight:normal; color:#888;">(ì„ íƒì‚¬í•­)</span></label>
          <input type="text" id="recommender" name="recommender" placeholder="ì¶”ì²œì¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
        </div>

        <div class="bank-section">
          <h3>ğŸ’° ë°°ë‹¹ê¸ˆ ì…ê¸ˆ ê³„ì¢Œ</h3>
          <p style="font-size:12px; color:#666; margin-bottom:15px;">ë°˜ë“œì‹œ <b>ë³¸ì¸(ë‹¨ì²´) ëª…ì˜ì˜ ê³„ì¢Œ</b>ë¥¼ ì ì–´ì£¼ì‹œê¸¸ ë°”ëë‹ˆë‹¤.</p>
          <div class="input-group"><label class="required">ì€í–‰ëª…</label>
              <select name="bankName" id="bankName" required>
                <option value="" disabled selected>ì€í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                <option value="ë†í˜‘">ë†í˜‘</option><option value="êµ­ë¯¼">êµ­ë¯¼</option><option value="ì‹ í•œ">ì‹ í•œ</option><option value="ìš°ë¦¬">ìš°ë¦¬</option>
                <option value="í•˜ë‚˜">í•˜ë‚˜</option><option value="ê¸°ì—…">ê¸°ì—…</option><option value="ì¹´ì¹´ì˜¤ë±…í¬">ì¹´ì¹´ì˜¤ë±…í¬</option><option value="í† ìŠ¤ë±…í¬">í† ìŠ¤ë±…í¬</option>
                <option value="ìƒˆë§ˆì„">ìƒˆë§ˆì„</option><option value="ì‹ í˜‘">ì‹ í˜‘</option><option value="ìš°ì²´êµ­">ìš°ì²´êµ­</option><option value="SCì œì¼">SCì œì¼</option><option value="ë¶€ì‚°">ë¶€ì‚°</option><option value="ëŒ€êµ¬">ëŒ€êµ¬</option><option value="ê´‘ì£¼">ê´‘ì£¼</option><option value="ì „ë¶">ì „ë¶</option><option value="ìˆ˜í˜‘">ìˆ˜í˜‘</option>
              </select>
          </div>
          <div class="input-group"><label class="required">ê³„ì¢Œë²ˆí˜¸ <span style="font-size:11px; color:#888;">(ìˆ«ìë§Œ ì…ë ¥ë¨)</span></label>
              <input type="text" id="accountNo" name="accountNo" placeholder="í•˜ì´í”ˆ(-) ì—†ì´ ì…ë ¥í•´ì£¼ì„¸ìš”" oninput="handleAccountInput(this)" onblur="checkAccountDuplicateServer()" required>
              <div id="accountError" class="field-error"></div>
          </div>
          <div class="input-group"><label class="required">ì˜ˆê¸ˆì£¼</label><input type="text" id="accountHolder" name="accountHolder" placeholder="ì´ë¦„ê³¼ ë‹¤ë¥¼ ê²½ìš° ìˆ˜ì •í•´ì£¼ì„¸ìš”" required></div>
        </div>

        <div class="agreement-box">
          <div class="check-item"><input type="checkbox" id="agree1" required> <span class="term-link" onclick="showTerm(event, 'privacy')">[í•„ìˆ˜] ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° í™œìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</span></div>
          <div class="check-item"><input type="checkbox" id="agree2" required> <span class="term-link" onclick="showTerm(event, 'purpose')">[í•„ìˆ˜] ì¡°í•©ì˜ ì„¤ë¦½ëª©ì ì— ë™ì˜í•˜ê³  ì˜ë¬´ë¥¼ ë‹¤í•˜ê² ìŠµë‹ˆë‹¤.</span></div>
          
          <div class="check-item"><input type="checkbox" id="agree3" required> <span class="term-link" onclick="showTerm(event, 'risk')">[í•„ìˆ˜] ì¶œìê¸ˆ ì†ì‹¤ ìœ„í—˜ ë° í™˜ê¸‰ ì œí•œ ë“±ì— ë™ì˜í•©ë‹ˆë‹¤.</span></div>
        </div>

        <button type="submit" id="btnSubmit">ê°€ì… ì‹ ì²­í•˜ê¸°</button>
      </form>
    </div>

    <div id="popoverModal" class="modal" onclick="this.classList.remove('show'); this.style.display='none';">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div style="font-size:16px; font-weight:bold; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #eee;" id="popoverTitle">ì•½ê´€ ë‚´ìš©</div>
        <div class="alert-text" id="popoverText"></div>
        <div style="text-align:right; margin-top:15px;"><button type="button" class="btn-dark" style="height:36px;" onclick="document.getElementById('popoverModal').classList.remove('show'); document.getElementById('popoverModal').style.display='none';">ë‹«ê¸°</button></div>
        <div class="modal-arrow" id="popoverArrow"></div>
      </div>
    </div>

    <div id="centerModal" class="center-modal">
       <div class="modal-content">
          <div id="centerMsg" style="margin-bottom:20px; white-space:pre-wrap; font-size:15px; color:#333;"></div>
          <button type="button" style="background:#4e8cff; color:white; border:none; padding:12px; width:100%; border-radius:6px; font-weight:bold; cursor:pointer;" onclick="document.getElementById('centerModal').style.display='none'">í™•ì¸</button>
       </div>
    </div>
    
    <div id="confirmModal" class="center-modal" style="z-index: 100000;">
       <div class="modal-content">
          <div id="confirmMsg" style="margin-bottom:20px; white-space:pre-wrap; font-size:15px; color:#333;"></div>
          <div style="display:flex; gap:10px;">
             <button id="btnConfirmCancel" type="button" style="flex:1; background:#f1f3f4; color:#333; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer;">ì·¨ì†Œ</button>
             <button id="btnConfirmOk" type="button" style="flex:1; background:#4e8cff; color:white; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer;">í™•ì¸</button>
          </div>
       </div>
    </div>
    
    <div id="successModal" class="center-modal">
      <div class="modal-content">
        <div style="font-size:40px; margin-bottom:10px;">ğŸ‰</div>
        <h3 style="margin:0 0 10px 0;">ê°€ì… ì‹ ì²­ ì™„ë£Œ</h3>
        <p style="color:#666; font-size:14px;">ì‹ ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì¶œìê¸ˆ ì…ê¸ˆ ê³„ì¢ŒëŠ” ğŸ¦ ì‹ í˜‘ 131-022-855516 (ì˜ˆê¸ˆì£¼: ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©)ì…ë‹ˆë‹¤.</p>
        <div class="kakao-box"><a href="https://invite.kakao.com/tc/cLtR3LGLQX" target="_blank" class="kakao-link-btn">ğŸ“¢ ì¹´ì¹´ì˜¤í†¡ íŒ€ì±„íŒ…ë°© ì°¸ì—¬í•˜ê¸°</a></div>
        <button class="btn-dark" style="width:100%; margin-top:20px;" onclick="location.reload()">ë‹«ê¸°</button>
      </div>
    </div>
    
<script>
// [1] Supabase ì„¤ì •
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k'; 
    
    // [ìˆ˜ì •] ë³€ìˆ˜ëª… ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ '_supabase'ë¡œ ë³€ê²½
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // [2] ì „ì—­ ë³€ìˆ˜
    var authTimer = null; 
    var btnCooldownTimer = null; 
    var termsData = {
      privacy: { title: "ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° í™œìš© ë™ì˜", content: "ë³¸ì¸ì€ã€Œê°œì¸ì •ë³´ë³´í˜¸ë²•ã€ì œ15ì¡°(ìˆ˜ì§‘Â·ì´ìš©Â·ì œê³µ) ë° ì œ17ì¡°(ê°œì¸ì •ë³´ì˜ ì œê³µ) ì œ1í•­ ì œ1í˜¸ì— ë”°ë¼ ê·€ ê¸°ê´€ì´ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘Â·ì´ìš©Â·ì œê³µ í•˜ëŠ” ê²ƒì— ëŒ€í•˜ì—¬ ë™ì˜í•©ë‹ˆë‹¤.\n\n1. ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ì´ìš© ëª©ì : (ê°€ì¹­)ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©ì˜ ì„¤ë¦½ ë° ë°°ë‹¹ê¸ˆ ì§€ê¸‰\n2. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ì˜ í•­ëª© : ì´ë¦„, íœ´ëŒ€í°ë²ˆí˜¸, ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ì£¼ì†Œ, ì´ë©”ì¼ ì£¼ì†Œ\n3. ê°œì¸ì •ë³´ì˜ ë³´ìœ  ë° ì´ìš© ê¸°ê°„: ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘Â·ì´ìš© ëª©ì  ë‹¬ì„±ì‹œê¹Œì§€, ë˜ëŠ” ì¡°í•©ì›ì´ ìì‹ ì˜ ê°œì¸ì •ë³´ì œê³µì˜ ë™ì˜ë¥¼ ì² íšŒí•œ ë•Œ. ë‹¨, ê´€ë ¨ ë²•ë ¹ì˜ ê·œì •ì— ì˜í•˜ì—¬ ê°œì¸ì •ë³´ë¥¼ ë³´ìœ í•  í•„ìš”ê°€ ìˆëŠ” ê²½ìš°, í•´ë‹¹ ë²•ë ¹ì—ì„œ ì •í•œ ê¸°ê°„ê¹Œì§€.\n\n* ìˆ˜ì§‘ëœ ê³ ìœ ì‹ë³„ì •ë³´(ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸)ëŠ” ì•”í˜¸í™”ë˜ì–´ ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤." },
      purpose: { title: "ì¡°í•©ì˜ ì„¤ë¦½ëª©ì  ë™ì˜", content: "<b>ì œ2ì¡°(ëª©ì )</b> ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©(ì´í•˜ â€˜ì¡°í•©â€™ì´ë¼ í•œë‹¤)ì€ ìì£¼ì Â·ìë¦½ì Â·ìì¹˜ì ì¸ í˜‘ë™ì¡°í•© í™œë™ì„ í†µí•˜ì—¬ ì‹œë¯¼ì°¸ì—¬í˜• íƒœì–‘ê´‘ ë°œì „ì†Œë¥¼ ì„¤ë¦½Â·ìš´ì˜í•˜ê³ , í–‡ë¹›ì„ ë‹®ì•„ ëª¨ë“  ìƒëª…ì´ ê³µí‰í•œ ì‚¶ì„ ëˆ„ë¦´ ìˆ˜ ìˆë„ë¡ ì§€ì—­ê³µë™ì²´ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ìƒí˜¸ë¶€ì¡°ì˜ ê°€ì¹˜ë¥¼ ì‹¤ì²œí•¨ìœ¼ë¡œì¨ ê¸°í›„ìœ„ê¸°ì— ëŒ€ì‘í•˜ê³ , ì—ë„ˆì§€ ì „í™˜ì„ ì‹¤í˜„í•˜ë©°, ì·¨ì•½ê³„ì¸µì—ê²Œ ì¼ìë¦¬ì™€ ì‚¬íšŒì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ë“± ì§€ì—­ì‚¬íšŒì— ê¸°ì—¬í•¨ì„ ëª©ì ìœ¼ë¡œ í•œë‹¤." },
      risk: { title: "ì¶œìê¸ˆ ë° ë°°ë‹¹ ê´€ë ¨ ì¤‘ìš” ê³ ì§€", content: "1. ì¶œìê¸ˆì€ ì˜ˆê¸ˆìë³´í˜¸ ëŒ€ìƒì´ ì•„ë‹ˆë©° ì›ê¸ˆ ì†ì‹¤ ê°€ëŠ¥ì„±ì´ ìˆìŒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.\n\n2. íƒˆí‡´(ë˜ëŠ” ì œëª…) ì „ ì¤‘ë„ í™˜ê¸‰ì´ ì œí•œë  ìˆ˜ ìˆìŒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.\n\n3. í™˜ê¸‰ì€ ê²°ì‚° ë° ì´íšŒ ìŠ¹ì¸ ë“± ì ˆì°¨ í›„ ê°€ëŠ¥í•˜ë©° ì§€ì—°Â·ë¶„í•  ì§€ê¸‰ë  ìˆ˜ ìˆìŒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.\n\n4. ë°°ë‹¹ì€ ì´íšŒ ì˜ê²° ë° ê²½ì˜ì„±ê³¼ì— ë”°ë¼ ê²°ì •ë˜ë©° ì—†ì„ ìˆ˜ ìˆìŒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤." }
    };

    // [3] ìœ í‹¸ë¦¬í‹° ë° UI í•¨ìˆ˜
    function handleNumberOnly(el) { el.value = el.value.replace(/[^0-9]/g, ''); }
    function autoMove(c,n,l) { if(c.value.length>=l) document.getElementById(n).focus(); }
    
    function updateMoneyHint() {
       var v = document.getElementById('money').value;
       document.getElementById('moneyHint').textContent = (v>=100000 && v%10000===0) ? parseInt(v).toLocaleString()+'ì›' : '10ë§Œì› ì´ìƒ, 1ë§Œì› ë‹¨ìœ„';
    }

    function toggleType(t) {
      var isIndividual = (t === 'ê°œì¸'); var isOrg = (t === 'ë‹¨ì²´');
      document.getElementById('individualField').style.display = isIndividual ? 'block' : 'none';
      document.getElementById('orgField').style.display = isOrg ? 'block' : 'none';
      document.getElementById('userName').required = isIndividual; document.getElementById('rrn1').required = isIndividual; document.getElementById('rrn2').required = isIndividual;
      var orgNameInput = document.getElementById('orgName'); if(orgNameInput) orgNameInput.required = isOrg;
      syncAccountHolder();
    }

    function syncAccountHolder() {
      var t = document.querySelector('input[name="userType"]:checked').value;
      var val = (t==='ê°œì¸') ? document.getElementById('userName').value : document.getElementById('orgName').value;
      document.getElementById('accountHolder').value = val;
    }
    
    function handleAccountInput(el) { el.value = el.value.replace(/[^0-9]/g,''); }

    function checkAgeLimit() {
      var rrn1 = document.getElementById('rrn1').value; var rrn2 = document.getElementById('rrn2').value; 
      if (rrn1.length === 6 && rrn2.length >= 1) {
        var birthYearPrefix; var firstDigit = parseInt(rrn2.charAt(0));
        if (firstDigit === 1 || firstDigit === 2 || firstDigit === 5 || firstDigit === 6) birthYearPrefix = 19;
        else if (firstDigit === 3 || firstDigit === 4 || firstDigit === 7 || firstDigit === 8) birthYearPrefix = 20;
        else return;
        
        var birthYear = parseInt(birthYearPrefix + rrn1.substring(0, 2));
        var birthDate = new Date(birthYear, parseInt(rrn1.substring(2, 4)) - 1, parseInt(rrn1.substring(4, 6)));
        var today = new Date();
        var age = today.getFullYear() - birthDate.getFullYear();
        var m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;

        if (age < 19) {
          showAlert("â›” ë¯¸ì„±ë…„ì ê°€ì… ì œí•œ\n\n[ë¯¼ë²• ì œ5ì¡° 1í•­]ì— ë”°ë¼ ë¯¸ì„±ë…„ìì˜ ë²•ë¥ í–‰ìœ„ì—ëŠ” ë²•ì •ëŒ€ë¦¬ì¸ì˜ ë™ì˜ê°€ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.");
          document.getElementById('rrn1').value = ""; document.getElementById('rrn2').value = ""; document.getElementById('rrn1').focus();
        }
      }
    }

    function validateAndCheckBizNo() {
       var b1 = document.getElementById('biz1').value; var b2 = document.getElementById('biz2').value; var b3 = document.getElementById('biz3').value;
       var bizNo = b1 + b2 + b3;
       var errorDiv = document.getElementById('orgNoError');
       if(bizNo.length !== 10) { if(bizNo.length > 0) errorDiv.textContent = "ì‚¬ì—…ì(ê³ ìœ )ë²ˆí˜¸ 10ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }
       
       var checkID = [1, 3, 7, 1, 3, 7, 1, 3, 5]; var i, chkSum=0, c2, remander; 
       for (i=0; i<=7; i++) chkSum += checkID[i] * bizNo.charAt(i); 
       c2 = "0" + (checkID[8] * bizNo.charAt(8)); c2 = c2.substring(c2.length - 2); 
       chkSum += Math.floor(c2.charAt(0)) + Math.floor(c2.charAt(1)); 
       remander = (10 - (chkSum % 10)) % 10 ; 
       
       if (Math.floor(bizNo.charAt(9)) === remander) {
          errorDiv.textContent = ""; document.getElementById('orgNo').value = b1 + "-" + b2 + "-" + b3;
          checkOrgNoDuplicateServer(bizNo); 
       } else { errorDiv.textContent = "ìœ íš¨í•˜ì§€ ì•Šì€ ì‚¬ì—…ì(ê³ ìœ )ë²ˆí˜¸ì…ë‹ˆë‹¤."; document.getElementById('orgNo').value = ""; }
    }

    // [4] ëª¨ë‹¬ ë° íŒì—…
    function showAlert(msg) { 
        document.getElementById('centerMsg').innerHTML=msg.replace(/\n/g, '<br>'); 
        document.getElementById('centerModal').style.display='flex'; 
    }
    
    function showConfirm(msg, yesCallback) {
        document.getElementById('confirmMsg').innerHTML = msg.replace(/\n/g, '<br>');
        var modal = document.getElementById('confirmModal');
        document.getElementById('btnConfirmCancel').onclick = function() { modal.style.display = 'none'; };
        document.getElementById('btnConfirmOk').onclick = function() { modal.style.display = 'none'; if(yesCallback) yesCallback(); };
        modal.style.display = 'flex';
    }

    function showTerm(e, type) {
      e.preventDefault(); e.stopPropagation();
      var modal = document.getElementById('popoverModal');
      document.getElementById('popoverTitle').textContent = termsData[type].title;
      document.getElementById('popoverText').innerHTML = termsData[type].content.replace(/\n/g, '<br>');
      if(window.innerWidth <= 600) { modal.style.display = 'flex'; setTimeout(()=>modal.classList.add('show'), 10); }
      else {
        modal.classList.remove('show'); modal.style.display = 'block'; 
        var content = modal.querySelector('.modal-content'); var arrow = document.getElementById('popoverArrow');
        var clickY = e.pageY; var clickX = e.pageX; var topPos = clickY - content.offsetHeight - 15;
        if (topPos < window.scrollY + 10) { topPos = clickY + 25; arrow.style.top = "-8px"; arrow.style.bottom = "auto"; arrow.style.transform = "rotate(225deg)"; }
        else { arrow.style.bottom = "-8px"; arrow.style.top = "auto"; arrow.style.transform = "rotate(45deg)"; }
        content.style.position = 'absolute'; content.style.top = topPos + 'px'; content.style.left = Math.min(Math.max(10, clickX - 20), window.innerWidth - 320) + 'px';
      }
    }

    // [5] ì£¼ì†Œ ê²€ìƒ‰
    function execDaumPostcode() {
      new daum.Postcode({
        oncomplete: function(data) {
           var addr = data.roadAddress; if(data.buildingName) addr += " ("+data.buildingName+")";
           document.getElementById('postcode').value = data.zonecode; document.getElementById('roadAddress').value = addr;
           document.getElementById('layer').style.display = 'none';
        }, width:'100%', height:'100%'
      }).embed(document.getElementById('layer'));
      document.getElementById('layer').style.display = 'block';
    }
    function closeDaumPostcode() { document.getElementById('layer').style.display='none'; }

    // [6] Supabase ì¤‘ë³µì²´í¬ (ëª¨ë‘ _supabase ì‚¬ìš©)
    async function checkOrgNoDuplicateServer(valStr) {
      if (!valStr) return;
      var formatted = valStr.substring(0, 3) + "-" + valStr.substring(3, 5) + "-" + valStr.substring(5);
      const { count, error } = await _supabase.from('coop_members').select('*', { count: 'exact', head: true }).eq('rrn_display', formatted);
      if (count > 0) document.getElementById('orgNoError').textContent = 'ì´ë¯¸ ê°€ì…ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.';
    }

    async function checkAccountDuplicateServer() {
      var val = document.getElementById('accountNo').value;
      if (!val) return;
      const { count, error } = await _supabase.from('coop_members').select('*', { count: 'exact', head: true }).eq('account_number', val);
      if (count > 0) document.getElementById('accountError').textContent = 'ì´ë¯¸ ë“±ë¡ëœ ê³„ì¢Œì…ë‹ˆë‹¤.';
    }

    async function checkPhoneDuplicateServer() {
      var userType = document.querySelector('input[name="userType"]:checked').value;
      if (userType === 'ë‹¨ì²´') return;
      var p = document.getElementById('p1').value + "-" + document.getElementById('p2').value + "-" + document.getElementById('p3').value;
      const { count, error } = await _supabase.from('coop_members').select('*', { count: 'exact', head: true }).eq('phone', p);
      if (count > 0) document.getElementById('phoneError').textContent = 'ì´ë¯¸ ê°€ì…ëœ ì—°ë½ì²˜ì…ë‹ˆë‹¤.';
    }

    // [7] ì´ë©”ì¼ ì¸ì¦
    function startTimer(duration, display) {
      var timer = duration, minutes, seconds; if(authTimer) clearInterval(authTimer);
      authTimer = setInterval(function () {
        minutes = parseInt(timer / 60, 10); seconds = parseInt(timer % 60, 10);
        minutes = minutes < 10 ? "0" + minutes : minutes; seconds = seconds < 10 ? "0" + seconds : seconds;
        display.textContent = minutes + ":" + seconds;
        if (--timer < 0) { 
            clearInterval(authTimer); display.textContent = "ë§Œë£Œ"; 
            showAlert("â° ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); 
            document.getElementById('authCode').value = ''; document.getElementById('authBox').style.display = 'none'; 
        }
      }, 1000);
    }

    function startButtonCooldown(duration, btn) {
      var timer = duration, minutes, seconds; if (btnCooldownTimer) clearInterval(btnCooldownTimer);
      btn.disabled = true; 
      btnCooldownTimer = setInterval(function () {
        minutes = parseInt(timer / 60, 10); seconds = parseInt(timer % 60, 10);
        minutes = minutes < 10 ? "0" + minutes : minutes; seconds = seconds < 10 ? "0" + seconds : seconds;
        btn.textContent = "ì¬ë°œì†¡ (" + minutes + ":" + seconds + ")";
        if (--timer < 0) { clearInterval(btnCooldownTimer); btn.textContent = "ì¸ì¦ë²ˆí˜¸ ì¬ë°œì†¡"; btn.disabled = false; }
      }, 1000);
    }

    async function reqEmailAuth() {
      var em = document.getElementById('email').value;
      var btn = document.getElementById('btnEmailReq');
      if (!em) return showAlert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');
      btn.disabled = true; btn.textContent = "ë°œì†¡ ì¤‘...";

      const { data, error } = await _supabase.auth.signInWithOtp({ email: em, options: { shouldCreateUser: true } });

      if (error) {
         showAlert("ì˜¤ë¥˜: " + error.message);
         btn.disabled = false; btn.textContent = "ì¸ì¦";
      } else {
         showAlert('ğŸ“§ ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\në©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
         document.getElementById('authBox').style.display = 'flex';
         document.getElementById('authCode').focus();
         startTimer(300, document.querySelector('#timer'));
         startButtonCooldown(180, btn);
      }
    }

    async function handleAuthCodeInput() {
      var val = document.getElementById('authCode').value;
      var email = document.getElementById('email').value;
      if (val.length === 6) {
         document.getElementById('authCode').readOnly = true;
         const { data, error } = await _supabase.auth.verifyOtp({ email: email, token: val, type: 'email' });
         if (error) {
            document.getElementById('authCode').readOnly = false;
            document.getElementById('emailError').textContent = 'ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.';
         } else {
            document.getElementById('emailError').textContent = '';
            document.getElementById('authSuccessMsg').style.display = 'block';
            document.getElementById('authBox').style.display = 'none';
            document.getElementById('isEmailVerified').value = 'true';
            document.getElementById('btnEmailReq').textContent = "ì¸ì¦ì™„ë£Œ";
            if (authTimer) clearInterval(authTimer);
            if (btnCooldownTimer) clearInterval(btnCooldownTimer);
         }
      }
    }
    
    function enableEmailEdit() {
        showConfirm("ì´ë©”ì¼ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìˆ˜ì • ì‹œ ì¸ì¦ì„ ë‹¤ì‹œ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.", function() {
            var emailInput = document.getElementById('email');
            emailInput.readOnly = false; emailInput.style.backgroundColor = "#fff"; emailInput.focus();
            document.getElementById('btnEmailEdit').style.display = 'none';
            document.getElementById('btnEmailReq').style.display = 'block';
            document.getElementById('isEmailVerified').value = 'false';
            document.getElementById('authSuccessMsg').style.display = 'none';
            document.getElementById('btnEmailReq').textContent = "ì¸ì¦";
            document.getElementById('btnEmailReq').disabled = false;
        });
    }

    // [8] íšŒì›ê°€ì… ì œì¶œ
    async function handleFormSubmit(e, form) {
      e.preventDefault();
      
      var userType = document.querySelector('input[name="userType"]:checked').value;
      if (userType === 'ê°œì¸') {
         if (document.getElementById('userName').value.trim().length < 2) return showAlert('ì´ë¦„ì„ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      } else {
         if (document.getElementById('orgName').value.trim().length < 2) return showAlert('ë‹¨ì²´ëª…ì„ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
         if (document.getElementById('orgNo').value.length < 10) return showAlert('ì‚¬ì—…ì(ê³ ìœ )ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
      var p2 = document.getElementById('p2').value; var p3 = document.getElementById('p3').value;
      if(p2.length < 3 || p3.length < 4) return showAlert('ì „í™”ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');

      var currentEmail = document.getElementById('email').value;
      var isVerified = document.getElementById('isEmailVerified').value === 'true';
      if (!isVerified) return showAlert('ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.');

      if(document.getElementById('accountError').textContent || document.getElementById('rrnError').textContent || document.getElementById('orgNoError').textContent) return showAlert('ì…ë ¥ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');

      document.getElementById('fullPhone').value = document.getElementById('p1').value+"-"+document.getElementById('p2').value+"-"+document.getElementById('p3').value;
      document.getElementById('fullAddress').value = "("+document.getElementById('postcode').value+") "+document.getElementById('roadAddress').value+" "+document.getElementById('detailAddress').value;

      document.getElementById('btnSubmit').disabled = true;
      document.getElementById('btnSubmit').textContent = 'ì²˜ë¦¬ì¤‘...';

      const formData = new FormData(form);
      const insertData = {
          name: formData.get('userName') || formData.get('orgName'),
          member_type: userType,
          rrn_encrypted: document.getElementById('rrn1').value + document.getElementById('rrn2').value,
          rrn_display: document.getElementById('rrn1').value + "-" + document.getElementById('rrn2').value.charAt(0) + "******",
          phone: document.getElementById('fullPhone').value,
          email: formData.get('email'),
          address: document.getElementById('fullAddress').value,
          pledge_amount: Number(formData.get('money')),
          recommender: formData.get('recommender'),
          bank_name: formData.get('bankName'),
          account_number: formData.get('accountNo'),
          account_holder: formData.get('accountHolder'),
          is_agreed: true,
          join_path: 'í™ˆí˜ì´ì§€',
          payment_status: 'ë¯¸ë‚©',
          status: 'ì •ìƒ'
      };

      // [í•µì‹¬] _supabase ì‚¬ìš©
      const { data, error } = await _supabase.from('coop_members').insert([insertData]).select();

      if (error) {
         console.error("DB Error:", error);
         showAlert("ê°€ì… ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n" + error.message);
         document.getElementById('btnSubmit').disabled = false;
         document.getElementById('btnSubmit').textContent = 'ê°€ì… ì‹ ì²­í•˜ê¸°';
      } else {
         document.getElementById('successModal').style.display = 'flex';
      }
    }

    // [9] SNS ë¡œê·¸ì¸
    async function startKakaoSignup() {
      const { data, error } = await _supabase.auth.signInWithOAuth({
          provider: 'kakao',
          options: { redirectTo: window.location.href }
      });
      if (error) showAlert("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜: " + error.message);
    }

    // [10] ì´ˆê¸°í™” ë° SNS ë³µê·€ ì²˜ë¦¬
    window.onload = async function() {
      const { data: { session } } = await _supabase.auth.getSession();
      if (session) {
          console.log("ë¡œê·¸ì¸ ì„±ê³µ:", session.user);
          const meta = session.user.user_metadata;
          if(meta) {
              if(meta.full_name) {
                  document.getElementById('userName').value = meta.full_name;
                  syncAccountHolder();
              }
              if(meta.email) {
                  const emailInput = document.getElementById('email');
                  emailInput.value = meta.email;
                  emailInput.readOnly = true;
                  emailInput.style.backgroundColor = "#e8f0fe";
                  document.getElementById('isEmailVerified').value = 'true';
                  document.getElementById('btnEmailReq').style.display = 'none';
                  document.getElementById('authBox').style.display = 'none';
                  
                  if(!document.getElementById('snsAuthMsg')) {
                       const msg = document.createElement('div');
                       msg.id = 'snsAuthMsg';
                       msg.style.cssText = "color:blue; font-size:12px; margin-top:5px; font-weight:bold;";
                       msg.innerText = "âœ… SNS ê³„ì •ìœ¼ë¡œ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.";
                       document.getElementById('authBox').parentNode.appendChild(msg);
                  }
              }
          }
      }
    };
      </script>
  </body>
</html>
